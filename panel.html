<!--
panel.html -- Live dashboard for the FRANZ pipeline monitor.

Served by panel.py on port 1234. Connects to /events via Server-Sent
Events to receive real-time turn data as JSON.

Four-quadrant layout optimized for 16:9 displays:
  Top-left:     Story (previous VLM output sent as context)
  Top-right:    Feedback (full execution results from tools)
  Bottom-left:  VLM Response (model output, Python script)
  Bottom-right: Screenshot (captured screen with cursor overlay)

The quadrant intersection point is draggable to resize all four
quadrants simultaneously. The screenshot image auto-scales to fill
its quadrant while preserving aspect ratio.

Feedback text is displayed from the full untruncated field
(feedback_text_full) to maintain Single Source of Truth. No data
is sliced or truncated in the display layer.

Includes pause/unpause control for the agent loop via PAUSED file.
No external dependencies. Single server on port 1234.
-->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FRANZ Panel</title>
<style>
:root {
    --bg: #0a0a0f;
    --bg-card: #12121a;
    --bg-card-hover: #1a1a25;
    --border: #2a2a3a;
    --text: #d0d0e0;
    --text-dim: #707088;
    --accent: #4a9eff;
    --accent-dim: #2a5a9a;
    --green: #40c040;
    --red: #e04040;
    --orange: #e0a020;
    --purple: #c080ff;
    --mono: 'Consolas', 'Courier New', 'Liberation Mono', monospace;
    --header-h: 38px;
    --controls-h: 34px;
    --sep-size: 8px;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    background: var(--bg);
    color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-size: 14px;
    line-height: 1.5;
    overflow: hidden;
    height: 100vh;
    width: 100vw;
}
.header {
    height: var(--header-h);
    background: var(--bg);
    border-bottom: 1px solid var(--border);
    padding: 0 16px;
    display: flex;
    align-items: center;
    gap: 16px;
    flex-shrink: 0;
}
.header h1 {
    font-size: 15px;
    font-weight: 700;
    color: var(--accent);
    letter-spacing: 2px;
}
.header .status {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 11px;
    color: var(--text-dim);
}
.header .status .dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background: var(--red);
    transition: background 0.3s;
}
.header .status .dot.connected {
    background: var(--green);
    box-shadow: 0 0 5px var(--green);
}
.header .stats {
    margin-left: auto;
    display: flex;
    gap: 14px;
    font-size: 11px;
    color: var(--text-dim);
    font-family: var(--mono);
}
.header .stats span { color: var(--text); }
.controls {
    height: var(--controls-h);
    padding: 0 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    gap: 12px;
    align-items: center;
    font-size: 11px;
    flex-shrink: 0;
}
.controls label {
    display: flex;
    align-items: center;
    gap: 4px;
    color: var(--text-dim);
    cursor: pointer;
    user-select: none;
}
.controls input[type="checkbox"] { accent-color: var(--accent); }
.controls button {
    background: var(--bg-card);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 3px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 11px;
}
.controls button:hover {
    background: var(--bg-card-hover);
    border-color: var(--accent-dim);
}
.controls button.pause-active {
    background: rgba(224,64,64,0.15);
    border-color: var(--red);
    color: var(--red);
}
.controls .turn-nav {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 6px;
    font-family: var(--mono);
    color: var(--text-dim);
}
.controls .turn-nav button {
    min-width: 28px;
    text-align: center;
}
.controls .turn-nav .turn-indicator {
    min-width: 80px;
    text-align: center;
    color: var(--text);
}
.main-area {
    position: relative;
    width: 100%;
    height: calc(100vh - var(--header-h) - var(--controls-h));
    overflow: hidden;
}
.quadrant {
    position: absolute;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}
.q-header {
    height: 24px;
    min-height: 24px;
    padding: 0 10px;
    display: flex;
    align-items: center;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    user-select: none;
}
.q-content {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 8px 10px;
    font-family: var(--mono);
    font-size: 12px;
    line-height: 1.6;
    white-space: pre-wrap;
    word-break: break-word;
}
.q-content.empty-content {
    color: var(--text-dim);
    font-style: italic;
}
#qTL { top: 0; left: 0; border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); }
#qTR { top: 0; border-bottom: 1px solid var(--border); }
#qBL { left: 0; border-right: 1px solid var(--border); }
#qTL .q-header { color: var(--accent); background: rgba(74,158,255,0.06); }
#qTR .q-header { color: var(--orange); background: rgba(224,160,32,0.06); }
#qBL .q-header { color: var(--green); background: rgba(64,192,64,0.06); }
#qBR .q-header { color: var(--purple); background: rgba(192,128,255,0.06); }
#qBR .q-content {
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}
#qBR .q-content img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
    cursor: pointer;
}
#qBR .q-content img:hover { opacity: 0.85; }
.crosshair {
    position: absolute;
    z-index: 60;
    cursor: move;
}
.crosshair-h {
    position: absolute;
    left: 0;
    width: 100%;
    height: var(--sep-size);
    pointer-events: none;
}
.crosshair-v {
    position: absolute;
    top: 0;
    height: 100%;
    width: var(--sep-size);
    pointer-events: none;
}
.crosshair-center {
    position: absolute;
    width: calc(var(--sep-size) * 3);
    height: calc(var(--sep-size) * 3);
    border-radius: 50%;
    cursor: move;
    z-index: 70;
}
.crosshair:hover .crosshair-h,
.crosshair:hover .crosshair-v,
.crosshair.active .crosshair-h,
.crosshair.active .crosshair-v {
    background: rgba(74,158,255,0.25);
}
.crosshair:hover .crosshair-center,
.crosshair.active .crosshair-center {
    background: rgba(74,158,255,0.5);
}
.meta-section {
    margin-top: 10px;
    padding-top: 8px;
    border-top: 1px solid var(--border);
}
.meta-section .meta-title {
    font-size: 10px;
    font-weight: 600;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 4px;
}
.meta-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 2px 12px;
    font-size: 11px;
}
.meta-grid .key { color: var(--text-dim); }
.meta-grid .val { color: var(--text); }
.sst-badge {
    padding: 1px 6px;
    border-radius: 3px;
    font-size: 10px;
    font-weight: 600;
    font-family: var(--mono);
    margin-left: 8px;
}
.sst-badge.ok { background: rgba(64,192,64,0.15); color: var(--green); }
.sst-badge.fail { background: rgba(224,64,64,0.15); color: var(--red); }
.sst-badge.unknown { background: rgba(224,160,32,0.15); color: var(--orange); }
.sst-detail {
    margin-top: 8px;
    padding: 6px 8px;
    background: rgba(224,64,64,0.05);
    border: 1px solid rgba(224,64,64,0.3);
    border-radius: 3px;
    font-size: 11px;
    color: var(--red);
}
.error-block {
    margin-top: 8px;
    padding: 6px 8px;
    background: rgba(224,64,64,0.05);
    border: 1px solid rgba(224,64,64,0.3);
    border-radius: 3px;
    font-size: 11px;
    color: var(--red);
}
.turn-list-overlay {
    display: none;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--bg);
    z-index: 200;
    overflow-y: auto;
    padding: 16px;
}
.turn-list-overlay.visible { display: block; }
.turn-list-overlay .tl-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
}
.turn-list-overlay .tl-header h2 {
    font-size: 16px;
    color: var(--accent);
}
.turn-list-overlay .tl-header button {
    margin-left: auto;
    background: var(--bg-card);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 4px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
}
.turn-card-mini {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 6px;
    margin-bottom: 8px;
    overflow: hidden;
}
.turn-card-mini.sst-violation { border-color: var(--red); }
.turn-card-mini .tc-header {
    padding: 6px 12px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 12px;
    font-family: var(--mono);
    cursor: pointer;
    user-select: none;
}
.turn-card-mini .tc-header:hover { background: var(--bg-card-hover); }
.turn-card-mini .tc-header .tc-num {
    font-weight: 700;
    color: var(--accent);
    min-width: 50px;
}
.turn-card-mini .tc-header .tc-meta {
    color: var(--text-dim);
    font-size: 11px;
}
.turn-card-mini .tc-header .tc-expand {
    margin-left: auto;
    color: var(--text-dim);
    transition: transform 0.15s;
}
.turn-card-mini.expanded .tc-expand { transform: rotate(90deg); }
.turn-card-mini .tc-body {
    display: none;
    padding: 8px 12px;
    border-top: 1px solid var(--border);
}
.turn-card-mini.expanded .tc-body { display: block; }
.tc-body .tc-section { margin-bottom: 8px; }
.tc-body .tc-section-title {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 3px;
}
.tc-body .tc-section-title.story { color: var(--accent); }
.tc-body .tc-section-title.feedback { color: var(--orange); }
.tc-body .tc-section-title.vlm { color: var(--green); }
.tc-body .tc-section-title.screenshot { color: var(--purple); }
.tc-body .tc-text {
    background: #08080e;
    border: 1px solid var(--border);
    border-radius: 3px;
    padding: 6px 8px;
    font-family: var(--mono);
    font-size: 11px;
    line-height: 1.5;
    white-space: pre-wrap;
    word-break: break-word;
    color: var(--text);
}
.tc-body .tc-text.empty {
    color: var(--text-dim);
    font-style: italic;
}
.tc-body .tc-img-row { text-align: center; }
.tc-body .tc-img-row img {
    max-width: 100%;
    max-height: 300px;
    border-radius: 3px;
    cursor: pointer;
}
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }
</style>
</head>
<body>

<div class="header">
    <h1>FRANZ PANEL</h1>
    <div class="status">
        <div class="dot" id="connDot"></div>
        <span id="connText">Disconnected</span>
    </div>
    <div class="stats">
        Turns: <span id="statTurns">0</span> &nbsp;|&nbsp;
        Avg latency: <span id="statLatency">--</span> &nbsp;|&nbsp;
        SST violations: <span id="statViolations">0</span> &nbsp;|&nbsp;
        Errors: <span id="statErrors">0</span>
    </div>
</div>

<div class="controls">
    <label><input type="checkbox" id="chkAutoScroll" checked> Auto-advance</label>
    <label><input type="checkbox" id="chkNewestFirst" checked> Newest first</label>
    <button id="btnPause">Pause Agent</button>
    <button id="btnHistory">History</button>
    <button id="btnClear">Clear</button>
    <div class="turn-nav">
        <button id="btnFirst" title="First turn">&lt;&lt;</button>
        <button id="btnPrev" title="Previous turn">&lt;</button>
        <span class="turn-indicator" id="turnIndicator">-- / --</span>
        <button id="btnNext" title="Next turn">&gt;</button>
        <button id="btnLast" title="Latest turn">&gt;&gt;</button>
    </div>
</div>

<div class="main-area" id="mainArea">
    <div class="quadrant" id="qTL">
        <div class="q-header">Story -- Narrative Memory</div>
        <div class="q-content empty-content" id="qTLContent">(waiting for first turn)</div>
    </div>
    <div class="quadrant" id="qTR">
        <div class="q-header">Feedback -- Execution Results (Full)</div>
        <div class="q-content empty-content" id="qTRContent">(waiting for first turn)</div>
    </div>
    <div class="quadrant" id="qBL">
        <div class="q-header">VLM Response -- Python Script</div>
        <div class="q-content empty-content" id="qBLContent">(waiting for first turn)</div>
    </div>
    <div class="quadrant" id="qBR">
        <div class="q-header">Screenshot -- Live Screen</div>
        <div class="q-content empty-content" id="qBRContent">(waiting for first turn)</div>
    </div>
    <div class="crosshair" id="crosshair">
        <div class="crosshair-h" id="crossH"></div>
        <div class="crosshair-v" id="crossV"></div>
        <div class="crosshair-center" id="crossCenter"></div>
    </div>
    <div class="turn-list-overlay" id="historyOverlay">
        <div class="tl-header">
            <h2>Turn History</h2>
            <button id="btnCloseHistory">Close</button>
        </div>
        <div id="historyList"></div>
    </div>
</div>

<script>
(function() {
    "use strict";

    var turns = [];
    var currentIndex = -1;
    var totalLatency = 0;
    var violationCount = 0;
    var errorCount = 0;
    var eventSource = null;
    var splitX = 0.50;
    var splitY = 0.50;
    var paused = false;
    var pausePollTimer = null;

    var $ = function(id) { return document.getElementById(id); };
    var connDot = $("connDot");
    var connText = $("connText");
    var statTurns = $("statTurns");
    var statLatency = $("statLatency");
    var statViolations = $("statViolations");
    var statErrors = $("statErrors");
    var mainArea = $("mainArea");
    var qTL = $("qTL");
    var qTR = $("qTR");
    var qBL = $("qBL");
    var qBR = $("qBR");
    var qTLContent = $("qTLContent");
    var qTRContent = $("qTRContent");
    var qBLContent = $("qBLContent");
    var qBRContent = $("qBRContent");
    var crosshair = $("crosshair");
    var crossH = $("crossH");
    var crossV = $("crossV");
    var crossCenter = $("crossCenter");
    var chkAutoScroll = $("chkAutoScroll");
    var chkNewestFirst = $("chkNewestFirst");
    var btnPause = $("btnPause");
    var btnHistory = $("btnHistory");
    var btnClear = $("btnClear");
    var btnFirst = $("btnFirst");
    var btnPrev = $("btnPrev");
    var btnNext = $("btnNext");
    var btnLast = $("btnLast");
    var turnIndicator = $("turnIndicator");
    var historyOverlay = $("historyOverlay");
    var historyList = $("historyList");
    var btnCloseHistory = $("btnCloseHistory");

    function esc(s) {
        if (!s) return "";
        return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    function layoutQuadrants() {
        var w = mainArea.offsetWidth;
        var h = mainArea.offsetHeight;
        var sx = Math.max(0.15, Math.min(0.85, splitX));
        var sy = Math.max(0.15, Math.min(0.85, splitY));
        var half = 4;
        var lw = Math.round(w * sx) - half;
        var rw = w - lw - half * 2;
        var th = Math.round(h * sy) - half;
        var bh = h - th - half * 2;
        var lx = lw + half * 2;
        var ty = th + half * 2;

        qTL.style.cssText = "left:0;top:0;width:" + lw + "px;height:" + th + "px";
        qTR.style.cssText = "left:" + lx + "px;top:0;width:" + rw + "px;height:" + th + "px";
        qBL.style.cssText = "left:0;top:" + ty + "px;width:" + lw + "px;height:" + bh + "px";
        qBR.style.cssText = "left:" + lx + "px;top:" + ty + "px;width:" + rw + "px;height:" + bh + "px";

        var cx = lw;
        var cy = th;
        crosshair.style.cssText = "position:absolute;left:0;top:0;width:" + w + "px;height:" + h + "px;pointer-events:none";
        crossH.style.cssText = "position:absolute;left:0;top:" + (cy - half) + "px;width:" + w + "px;height:" + (half * 2) + "px;pointer-events:none";
        crossV.style.cssText = "position:absolute;left:" + (cx - half) + "px;top:0;width:" + (half * 2) + "px;height:" + h + "px;pointer-events:none";
        var cSize = half * 5;
        crossCenter.style.cssText = "position:absolute;left:" + (cx - cSize / 2) + "px;top:" + (cy - cSize / 2) + "px;width:" + cSize + "px;height:" + cSize + "px;border-radius:50%;cursor:move;z-index:70;pointer-events:auto";
    }

    (function initCrosshairDrag() {
        var dragging = false;
        crossCenter.addEventListener("mousedown", function(e) {
            e.preventDefault();
            dragging = true;
            crosshair.classList.add("active");
            document.body.style.cursor = "move";
            document.body.style.userSelect = "none";
        });
        document.addEventListener("mousemove", function(e) {
            if (!dragging) return;
            var rect = mainArea.getBoundingClientRect();
            splitX = (e.clientX - rect.left) / rect.width;
            splitY = (e.clientY - rect.top) / rect.height;
            layoutQuadrants();
        });
        document.addEventListener("mouseup", function() {
            if (dragging) {
                dragging = false;
                crosshair.classList.remove("active");
                document.body.style.cursor = "";
                document.body.style.userSelect = "";
            }
        });
    })();

    window.addEventListener("resize", layoutQuadrants);
    layoutQuadrants();

    function updateStats() {
        statTurns.textContent = turns.length;
        statLatency.textContent = turns.length > 0 ? Math.round(totalLatency / turns.length) + "ms" : "--";
        statViolations.textContent = violationCount;
        statErrors.textContent = errorCount;
        if (violationCount > 0) statViolations.style.color = "#e04040";
        if (errorCount > 0) statErrors.style.color = "#e0a020";
    }

    function updateIndicator() {
        if (turns.length === 0) {
            turnIndicator.textContent = "-- / --";
            return;
        }
        var t = turns[currentIndex];
        turnIndicator.textContent = "Turn " + (t.turn || currentIndex + 1) + " / " + turns.length;
    }

    function splitStoryFeedback(fullText) {
        if (!fullText) return { story: "", feedback: "" };
        var parts = fullText.split("\n\n");
        if (parts.length <= 1) return { story: fullText, feedback: "" };
        var last = parts[parts.length - 1];
        if (last.indexOf("->") >= 0 || last.indexOf("Available:") >= 0 || last.indexOf("No actions") >= 0) {
            var pos = fullText.lastIndexOf("\n\n" + last);
            if (pos >= 0) return { story: fullText.substring(0, pos), feedback: last };
        }
        return { story: fullText, feedback: "" };
    }

    function displayTurn(idx) {
        if (idx < 0 || idx >= turns.length) return;
        currentIndex = idx;
        var entry = turns[idx];
        var req = entry.request || {};
        var resp = entry.response || {};
        var sst = entry.sst_check || {};
        var sampling = req.sampling || {};
        var usage = resp.usage || {};

        var feedbackFull = req.feedback_text_full || req.feedback_text || "";
        var parsed = splitStoryFeedback(feedbackFull);
        var storyText = parsed.story;
        var feedbackText = parsed.feedback;

        var isViolation = sst.verified && !sst.match;
        var sstClass = !sst.verified ? "unknown" : (sst.match ? "ok" : "fail");
        var sstLabel = !sst.verified ? "?" : (sst.match ? "OK" : "VIOLATION");

        var storyHtml = storyText ? esc(storyText) : '<span style="color:var(--text-dim);font-style:italic">(empty -- first turn)</span>';
        storyHtml += '\n\n<span class="sst-badge ' + sstClass + '">SST: ' + sstLabel + '</span>';
        if (isViolation && sst.detail) {
            storyHtml += '\n<div class="sst-detail">' + esc(sst.detail) + '</div>';
        }
        storyHtml += '\n\n<div class="meta-section"><div class="meta-title">Turn Metadata</div><div class="meta-grid">';
        var metaItems = [
            ["model", esc(req.model)],
            ["temperature", sampling.temperature != null ? sampling.temperature : "?"],
            ["top_p", sampling.top_p != null ? sampling.top_p : "?"],
            ["max_tokens", sampling.max_tokens != null ? sampling.max_tokens : "?"],
            ["latency", Math.round(entry.latency_ms || 0) + "ms"],
            ["status", resp.status || "?"],
            ["req_size", (req.body_size_bytes || "?") + " B"],
            ["resp_size", (resp.body_size_bytes || "?") + " B"],
            ["prompt_tok", usage.prompt_tokens != null ? usage.prompt_tokens : "?"],
            ["compl_tok", usage.completion_tokens != null ? usage.completion_tokens : "?"],
            ["finish", esc(resp.finish_reason || "?")],
            ["timestamp", esc(entry.timestamp || "")],
            ["sst_len", req.sst_text_length || 0],
            ["msgs", req.messages_count || "?"],
            ["resp_id", esc(resp.response_id || "")],
            ["fingerprint", esc(resp.system_fingerprint || "")]
        ];
        for (var mi = 0; mi < metaItems.length; mi++) {
            storyHtml += '<div><span class="key">' + metaItems[mi][0] + ':</span> <span class="val">' + metaItems[mi][1] + '</span></div>';
        }
        storyHtml += '</div></div>';

        qTLContent.innerHTML = storyHtml;
        qTLContent.classList.remove("empty-content");

        if (feedbackText) {
            qTRContent.textContent = feedbackText;
            qTRContent.classList.remove("empty-content");
        } else {
            qTRContent.innerHTML = '<span style="color:var(--text-dim);font-style:italic">(no feedback)</span>';
            qTRContent.classList.add("empty-content");
        }
        if (resp.error) {
            qTRContent.innerHTML += '\n\n<div class="error-block">UPSTREAM ERROR: ' + esc(resp.error) + '</div>';
        }

        var vlmText = resp.vlm_text || "";
        if (vlmText) {
            qBLContent.textContent = vlmText;
            qBLContent.classList.remove("empty-content");
        } else {
            qBLContent.innerHTML = '<span style="color:var(--text-dim);font-style:italic">(empty response)</span>';
            qBLContent.classList.add("empty-content");
        }

        var imageDataUri = req.image_data_uri || "";
        if (req.has_image && imageDataUri) {
            qBRContent.innerHTML = '<img src="' + imageDataUri + '" alt="Turn ' + (entry.turn || "") + '" title="Click to open full size" onclick="window.open(this.src,\'_blank\')">';
            qBRContent.classList.remove("empty-content");
        } else {
            qBRContent.innerHTML = '<span style="color:var(--text-dim);font-style:italic">(no screenshot)</span>';
            qBRContent.classList.add("empty-content");
        }

        updateIndicator();
    }

    function goFirst() { if (turns.length > 0) displayTurn(0); }
    function goPrev() { if (currentIndex > 0) displayTurn(currentIndex - 1); }
    function goNext() { if (currentIndex < turns.length - 1) displayTurn(currentIndex + 1); }
    function goLast() { if (turns.length > 0) displayTurn(turns.length - 1); }

    btnFirst.addEventListener("click", goFirst);
    btnPrev.addEventListener("click", goPrev);
    btnNext.addEventListener("click", goNext);
    btnLast.addEventListener("click", goLast);

    document.addEventListener("keydown", function(e) {
        if (historyOverlay.classList.contains("visible")) return;
        if (e.key === "ArrowLeft" || e.key === "a") goPrev();
        else if (e.key === "ArrowRight" || e.key === "d") goNext();
        else if (e.key === "Home") goFirst();
        else if (e.key === "End") goLast();
    });

    function renderHistoryCard(entry, idx) {
        var t = entry.turn || 0;
        var req = entry.request || {};
        var resp = entry.response || {};
        var sst = entry.sst_check || {};
        var isViolation = sst.verified && !sst.match;

        var card = document.createElement("div");
        card.className = "turn-card-mini expanded" + (isViolation ? " sst-violation" : "");

        var hdr = document.createElement("div");
        hdr.className = "tc-header";
        hdr.innerHTML =
            '<span class="tc-num">Turn ' + t + '</span>' +
            '<span class="tc-meta">' +
            Math.round(entry.latency_ms || 0) + 'ms | ' +
            (resp.vlm_text_length || 0) + ' chars | ' +
            (resp.finish_reason || "?") +
            (resp.error ? ' | ERROR' : '') +
            '</span>' +
            '<span class="tc-expand">&#9654;</span>';
        hdr.addEventListener("click", function() { card.classList.toggle("expanded"); });
        hdr.addEventListener("dblclick", function() {
            historyOverlay.classList.remove("visible");
            displayTurn(idx);
        });

        var body = document.createElement("div");
        body.className = "tc-body";

        var feedbackFull = req.feedback_text_full || req.feedback_text || "";
        var parsed = splitStoryFeedback(feedbackFull);
        var storyText = parsed.story;
        var feedbackText = parsed.feedback;
        var vlmText = resp.vlm_text || "";
        var imageDataUri = req.image_data_uri || "";

        body.innerHTML =
            '<div class="tc-section">' +
            '<div class="tc-section-title story">Story (' + (req.sst_text_length || 0) + ' chars)</div>' +
            '<div class="tc-text' + (storyText ? '' : ' empty') + '">' + (storyText ? esc(storyText) : '(empty)') + '</div>' +
            '</div>' +
            '<div class="tc-section">' +
            '<div class="tc-section-title feedback">Feedback (Full)</div>' +
            '<div class="tc-text' + (feedbackText ? '' : ' empty') + '">' + (feedbackText ? esc(feedbackText) : '(none)') + '</div>' +
            '</div>' +
            '<div class="tc-section">' +
            '<div class="tc-section-title vlm">VLM Script (' + (resp.vlm_text_length || 0) + ' chars)</div>' +
            '<div class="tc-text' + (vlmText ? '' : ' empty') + '">' + (vlmText ? esc(vlmText) : '(empty)') + '</div>' +
            '</div>' +
            (req.has_image && imageDataUri ?
                '<div class="tc-section">' +
                '<div class="tc-section-title screenshot">Screenshot</div>' +
                '<div class="tc-img-row"><img src="' + imageDataUri +
                '" alt="Turn ' + t + '" onclick="window.open(this.src,\'_blank\')"></div></div>' : '') +
            (resp.error ? '<div class="error-block">ERROR: ' + esc(resp.error) + '</div>' : '');

        card.appendChild(hdr);
        card.appendChild(body);
        return card;
    }

    function showHistory() {
        historyList.innerHTML = "";
        var ordered = [];
        for (var i = 0; i < turns.length; i++) ordered.push(i);
        if (chkNewestFirst.checked) ordered.reverse();
        for (var j = 0; j < ordered.length; j++) {
            historyList.appendChild(renderHistoryCard(turns[ordered[j]], ordered[j]));
        }
        historyOverlay.classList.add("visible");
    }

    btnHistory.addEventListener("click", showHistory);
    btnCloseHistory.addEventListener("click", function() {
        historyOverlay.classList.remove("visible");
    });

    btnClear.addEventListener("click", function() {
        turns = [];
        currentIndex = -1;
        totalLatency = 0;
        violationCount = 0;
        errorCount = 0;
        updateStats();
        updateIndicator();
        var panels = [qTLContent, qTRContent, qBLContent, qBRContent];
        for (var i = 0; i < panels.length; i++) {
            panels[i].innerHTML = '<span style="color:var(--text-dim);font-style:italic">(waiting for first turn)</span>';
            panels[i].classList.add("empty-content");
        }
        historyList.innerHTML = "";
    });

    function updatePauseButton() {
        if (paused) {
            btnPause.textContent = "Resume Agent";
            btnPause.classList.add("pause-active");
        } else {
            btnPause.textContent = "Pause Agent";
            btnPause.classList.remove("pause-active");
        }
    }

    function checkPauseStatus() {
        var xhr = new XMLHttpRequest();
        xhr.open("GET", "/health", true);
        xhr.timeout = 3000;
        xhr.onload = function() {
            try {
                var data = JSON.parse(xhr.responseText);
                var wasPaused = paused;
                paused = !!data.paused;
                if (paused !== wasPaused) updatePauseButton();
            } catch(e) {}
        };
        xhr.onerror = function() {};
        xhr.send();
    }

    btnPause.addEventListener("click", function() {
        var action = paused ? "unpause" : "pause";
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/" + action, true);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.timeout = 5000;
        xhr.onload = function() {
            try {
                var data = JSON.parse(xhr.responseText);
                paused = !!data.paused;
                updatePauseButton();
            } catch(e) {}
        };
        xhr.onerror = function() {};
        xhr.send("{}");
    });

    pausePollTimer = setInterval(checkPauseStatus, 5000);
    checkPauseStatus();

    function connect() {
        if (eventSource) eventSource.close();
        eventSource = new EventSource("/events");

        eventSource.onopen = function() {
            connDot.classList.add("connected");
            connText.textContent = "Connected";
        };

        eventSource.onmessage = function(evt) {
            try {
                var data = JSON.parse(evt.data);
                if (data.type === "connected") return;

                turns.push(data);
                totalLatency += (data.latency_ms || 0);
                var sst = data.sst_check || {};
                if (sst.verified && !sst.match) violationCount++;
                var resp = data.response || {};
                if (resp.error) errorCount++;
                updateStats();

                if (chkAutoScroll.checked) {
                    displayTurn(turns.length - 1);
                } else {
                    updateIndicator();
                }
            } catch(e) {
                console.warn("SSE parse error:", e, evt.data);
            }
        };

        eventSource.onerror = function() {
            connDot.classList.remove("connected");
            connText.textContent = "Reconnecting...";
        };
    }

    connect();
})();
</script>
</body>
</html>
